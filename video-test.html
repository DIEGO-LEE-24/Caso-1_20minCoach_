<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Videollamadas - 20minCoach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-4">🎥 Test de Videollamadas</h1>
            <p class="text-gray-300">Prueba el sistema de videollamadas de 20minCoach</p>
        </header>

        <!-- Estado de permisos -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">📹 Estado de Permisos</h2>
            <div id="permissions-status" class="space-y-2">
                <div class="flex items-center space-x-2">
                    <span id="camera-status" class="w-3 h-3 bg-red-500 rounded-full"></span>
                    <span>Cámara: <span id="camera-text">No autorizada</span></span>
                </div>
                <div class="flex items-center space-x-2">
                    <span id="microphone-status" class="w-3 h-3 bg-red-500 rounded-full"></span>
                    <span>Micrófono: <span id="microphone-text">No autorizado</span></span>
                </div>
            </div>
        </div>

        <!-- Controles de prueba -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">🎮 Controles de Prueba</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button id="request-permissions" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">
                    Solicitar Permisos
                </button>
                <button id="start-camera" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors" disabled>
                    Iniciar Cámara
                </button>
                <button id="stop-camera" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors" disabled>
                    Detener Cámara
                </button>
                <button id="test-connection" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition-colors" disabled>
                    Test Conexión
                </button>
            </div>
        </div>

        <!-- Vista de video -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">📺 Vista de Video</h2>
            <div class="relative bg-black rounded-lg overflow-hidden" style="height: 400px;">
                <!-- Video local -->
                <video id="local-video" autoplay muted playsinline 
                       class="w-full h-full object-cover">
                </video>
                
                <!-- Información superpuesta -->
                <div class="absolute top-4 left-4 bg-black/70 rounded-lg px-3 py-2">
                    <p class="text-sm">Video Local</p>
                    <p id="video-status" class="text-xs text-gray-400">Detenido</p>
                </div>

                <!-- Controles superpuestos -->
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-4">
                    <button id="toggle-video" class="bg-gray-700 hover:bg-gray-600 p-3 rounded-full transition-colors" disabled>
                        📹
                    </button>
                    <button id="toggle-audio" class="bg-gray-700 hover:bg-gray-600 p-3 rounded-full transition-colors" disabled>
                        🎤
                    </button>
                </div>
            </div>
        </div>

        <!-- Log de actividad -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">📋 Log de Actividad</h2>
            <div id="activity-log" class="bg-gray-900 rounded-lg p-4 h-48 overflow-y-auto font-mono text-sm">
                <div class="text-gray-400">Esperando actividad...</div>
            </div>
            <button id="clear-log" class="mt-4 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition-colors">
                Limpiar Log
            </button>
        </div>
    </div>

    <script>
        // Estado global
        let localStream = null;
        let peerConnection = null;

        // Referencias a elementos
        const localVideo = document.getElementById('local-video');
        const cameraStatus = document.getElementById('camera-status');
        const cameraText = document.getElementById('camera-text');
        const microphoneStatus = document.getElementById('microphone-status');
        const microphoneText = document.getElementById('microphone-text');
        const videoStatus = document.getElementById('video-status');
        const activityLog = document.getElementById('activity-log');

        // Botones
        const requestPermissionsBtn = document.getElementById('request-permissions');
        const startCameraBtn = document.getElementById('start-camera');
        const stopCameraBtn = document.getElementById('stop-camera');
        const testConnectionBtn = document.getElementById('test-connection');
        const toggleVideoBtn = document.getElementById('toggle-video');
        const toggleAudioBtn = document.getElementById('toggle-audio');
        const clearLogBtn = document.getElementById('clear-log');

        // Funciones de utilidad
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-blue-400">[${timestamp}]</span> ${message}`;
            activityLog.appendChild(logEntry);
            activityLog.scrollTop = activityLog.scrollHeight;
        }

        function updateStatus(element, text, isSuccess) {
            element.className = `w-3 h-3 rounded-full ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            text.textContent = isSuccess ? 'Autorizado' : 'No autorizado';
        }

        // Solicitar permisos
        async function requestPermissions() {
            log('🔑 Solicitando permisos de cámara y micrófono...');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: true
                });
                
                log('✅ Permisos otorgados exitosamente');
                updateStatus(cameraStatus, cameraText, true);
                updateStatus(microphoneStatus, microphoneText, true);
                
                // Detener el stream temporal
                stream.getTracks().forEach(track => track.stop());
                
                // Habilitar controles
                startCameraBtn.disabled = false;
                testConnectionBtn.disabled = false;
                
            } catch (error) {
                log(`❌ Error al solicitar permisos: ${error.message}`);
                updateStatus(cameraStatus, cameraText, false);
                updateStatus(microphoneStatus, microphoneText, false);
            }
        }

        // Iniciar cámara
        async function startCamera() {
            log('📹 Iniciando cámara...');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: true
                });
                
                localVideo.srcObject = localStream;
                videoStatus.textContent = 'Activo';
                videoStatus.className = 'text-xs text-green-400';
                
                log('✅ Cámara iniciada correctamente');
                
                // Habilitar controles de video
                toggleVideoBtn.disabled = false;
                toggleAudioBtn.disabled = false;
                stopCameraBtn.disabled = false;
                startCameraBtn.disabled = true;
                
            } catch (error) {
                log(`❌ Error al iniciar cámara: ${error.message}`);
            }
        }

        // Detener cámara
        function stopCamera() {
            log('🛑 Deteniendo cámara...');
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                localVideo.srcObject = null;
                videoStatus.textContent = 'Detenido';
                videoStatus.className = 'text-xs text-gray-400';
                
                log('✅ Cámara detenida');
                
                // Deshabilitar controles
                toggleVideoBtn.disabled = true;
                toggleAudioBtn.disabled = true;
                stopCameraBtn.disabled = true;
                startCameraBtn.disabled = false;
            }
        }

        // Test de conexión WebRTC
        async function testConnection() {
            log('🔗 Iniciando test de conexión WebRTC...');
            
            try {
                // Crear peer connection
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                // Eventos de conexión
                peerConnection.oniceconnectionstatechange = () => {
                    log(`🔄 Estado de ICE: ${peerConnection.iceConnectionState}`);
                };
                
                peerConnection.onconnectionstatechange = () => {
                    log(`🔄 Estado de conexión: ${peerConnection.connectionState}`);
                };
                
                peerConnection.onicegatheringstatechange = () => {
                    log(`🔄 Estado de gathering: ${peerConnection.iceGatheringState}`);
                };
                
                // Agregar tracks si hay stream
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                        log(`➕ Track agregado: ${track.kind}`);
                    });
                }
                
                // Crear offer para test
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                log('✅ Offer creado exitosamente');
                log(`📝 Offer SDP: ${offer.sdp.substring(0, 100)}...`);
                
            } catch (error) {
                log(`❌ Error en test de conexión: ${error.message}`);
            }
        }

        // Toggle video
        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    toggleVideoBtn.textContent = videoTrack.enabled ? '📹' : '📹❌';
                    log(`🎥 Video ${videoTrack.enabled ? 'activado' : 'desactivado'}`);
                }
            }
        }

        // Toggle audio
        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    toggleAudioBtn.textContent = audioTrack.enabled ? '🎤' : '🎤❌';
                    log(`🎵 Audio ${audioTrack.enabled ? 'activado' : 'desactivado'}`);
                }
            }
        }

        // Limpiar log
        function clearLog() {
            activityLog.innerHTML = '<div class="text-gray-400">Log limpiado...</div>';
        }

        // Event listeners
        requestPermissionsBtn.addEventListener('click', requestPermissions);
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        testConnectionBtn.addEventListener('click', testConnection);
        toggleVideoBtn.addEventListener('click', toggleVideo);
        toggleAudioBtn.addEventListener('click', toggleAudio);
        clearLogBtn.addEventListener('click', clearLog);

        // Cleanup al cerrar la página
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
        });

        // Log inicial
        log('🚀 Sistema de prueba de videollamadas iniciado');
        log('📋 Instrucciones:');
        log('1. Hacer clic en "Solicitar Permisos" para autorizar cámara y micrófono');
        log('2. Hacer clic en "Iniciar Cámara" para ver tu video');
        log('3. Usar los controles para probar funcionalidades');
        log('4. Hacer clic en "Test Conexión" para probar WebRTC');
    </script>
</body>
</html>